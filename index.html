<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Z_Chat_Lite</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    body { background-color: #111; color: white; font-family: Tahoma; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
    #chat-box { width: 95%; max-width: 600px; height: 400px; overflow-y: auto; background: #1a1a1a; border-radius: 10px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; }
    .message { max-width: 80%; padding: 8px 12px; margin: 5px 0; border-radius: 10px; word-wrap: break-word; }
    .my-message { background-color: #0f0; color: #000; align-self: flex-end; margin-right: auto; }
    .other-message { background-color: #333; color: #fff; align-self: flex-start; }
    .sender { font-weight: bold; font-size: 0.8em; margin-bottom: 3px; display: block; }
    input, button { padding: 10px; border-radius: 5px; border: none; margin: 2px; }
    input { background: #222; color: #fff; border: 1px solid #444; }
    button { background-color: #0f0; color: black; cursor: pointer; font-weight: bold; }
    #side-menu { position: fixed; left: 10px; top: 10px; z-index: 100; }
    .menu-panel { position: fixed; left: 10px; top: 60px; background: #222; padding: 10px; border-radius: 8px; display: none; width: 200px; max-height: 70vh; overflow-y: auto; border: 1px solid #0f0; }
    #notif-btn { position: fixed; right: 10px; top: 10px; }
    .unread-dot { background: red; border-radius: 50%; padding: 2px 6px; font-size: 10px; }
  </style>
</head>
<body>

  <div id="side-menu">
    <button onclick="togglePanel('onlineList')">ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
    <button onclick="togglePanel('friendsList')">ğŸ¤ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
  </div>

  <div id="notif-btn">
    <button onclick="togglePanel('notifications')">ğŸ”” <span id="notif-count" class="unread-dot" style="display:none">0</span></button>
  </div>

  <div id="onlineList" class="menu-panel"><strong>Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†:</strong><div id="users-area"></div></div>
  <div id="friendsList" class="menu-panel"><strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡:</strong><div id="friends-area"></div></div>
  <div id="notifications" class="menu-panel"><strong>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:</strong><div id="notif-area"></div></div>

  <h2 style="color: #0f0;">â„¤ ğ”¼ ğ• ğ”¼ ğ•€ ğ•ƒ  ğ•ƒğ•€ğ•‹ğ”¼</h2>

  <div style="display: flex; flex-wrap: wrap; justify-content: center;">
    <input type="text" id="room" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
    <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ">
    <button onclick="joinRoom()">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
  </div>

  <div id="chat-box" style="display: flex; flex-direction: column;"></div>

  <div style="width: 95%; max-width: 600px; display: flex;">
    <input type="text" id="message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="flex-grow: 1;">
    <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <div id="passwordModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; padding:20px; border:1px solid #0f0; border-radius:10px; z-index:1000;">
      <p>Ø§Ù„ØºØ±ÙØ© Ù…Ø­Ù…ÙŠØ©ØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯:</p>
      <input type="password" id="passInput">
      <button onclick="checkPass()">Ø¯Ø®ÙˆÙ„</button>
  </div>

<script>
  // Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡Ù†Ø§
  const firebaseConfig = {
    apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
    authDomain: "zeweil-chat.firebaseapp.com",
    databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "zeweil-chat",
    storageBucket: "zeweil-chat.appspot.com",
    messagingSenderId: "79843372176",
    appId: "1:79843372176:web:ea511efffae60c2a6cfc15",
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let currentRoom = "", currentUser = "", userId = "";

  firebase.auth().signInAnonymously().then(u => {
      userId = u.user.uid;
      loadFriends();
      loadNotifications();
  });

  function togglePanel(id) {
      const p = document.getElementById(id);
      const isVisible = p.style.display === "block";
      document.querySelectorAll('.menu-panel').forEach(el => el.style.display = 'none');
      p.style.display = isVisible ? "none" : "block";
  }

  function joinRoom() {
      currentRoom = document.getElementById("room").value.trim();
      currentUser = document.getElementById("username").value.trim();
      if(!currentRoom || !currentUser) return;

      db.ref(`rooms/${currentRoom}`).once('value', snap => {
          const data = snap.val();
          if(data && data.status === "passwordProtected") {
              document.getElementById("passwordModal").style.display = "block";
          } else {
              startChat();
          }
      });
  }

  function checkPass() {
      const p = document.getElementById("passInput").value;
      db.ref(`rooms/${currentRoom}/password`).once('value', snap => {
          if(snap.val() === p) {
              document.getElementById("passwordModal").style.display = "none";
              startChat();
          } else { alert("Ø®Ø·Ø£!"); }
      });
  }

  function startChat() {
      const chat = document.getElementById("chat-box");
      chat.innerHTML = "";
      db.ref(`rooms/${currentRoom}/messages`).limitToLast(50).on('child_added', snap => {
          const m = snap.val();
          const div = document.createElement("div");
          div.className = `message ${m.userId === userId ? 'my-message' : 'other-message'}`;
          div.innerHTML = `<span class="sender">${m.name}</span>${m.message}`;
          chat.appendChild(div);
          chat.scrollTop = chat.scrollHeight;
      });
      updateOnlineStatus();
  }

  function sendMessage() {
      const msg = document.getElementById("message").value;
      if(!msg || !currentRoom) return;
      db.ref(`rooms/${currentRoom}/messages`).push({
          userId: userId, name: currentUser, message: msg, timestamp: Date.now()
      });
      document.getElementById("message").value = "";
  }

  function updateOnlineStatus() {
      db.ref(`rooms/${currentRoom}/users/${userId}`).set({ name: currentUser, online: true });
      db.ref(`rooms/${currentRoom}/users`).on('value', snap => {
          const area = document.getElementById("users-area");
          area.innerHTML = "";
          snap.forEach(u => {
              area.innerHTML += `<div>â€¢ ${u.val().name}</div>`;
          });
      });
  }

  function loadFriends() {
      db.ref(`users/${userId}/friends`).on('value', snap => {
          const area = document.getElementById("friends-area");
          area.innerHTML = "";
          snap.forEach(f => {
              db.ref(`users/${f.key}/name`).once('value', n => {
                  area.innerHTML += `<div>ğŸ‘¤ ${n.val() || 'ØµØ¯ÙŠÙ‚'}</div>`;
              });
          });
      });
  }

  function loadNotifications() {
      db.ref(`users/${userId}/notifications`).on('value', snap => {
          const area = document.getElementById("notif-area");
          const count = document.getElementById("notif-count");
          area.innerHTML = "";
          let c = 0;
          snap.forEach(n => {
              area.innerHTML += `<div style="border-bottom:1px solid #444; padding:5px">${n.val().messageContent}</div>`;
              if(!n.val().isRead) c++;
          });
          count.innerText = c;
          count.style.display = c > 0 ? "inline" : "none";
      });
  }
</script>
</body>
</html>
