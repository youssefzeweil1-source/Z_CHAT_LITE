<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z_CHAT_LITE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        :root { --main-color: #0f0; --bg-dark: #111; --panel-bg: #1a1a1a; }
        body { background-color: var(--bg-dark); color: white; font-family: Tahoma, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .brand-title { color: var(--main-color); text-shadow: 0 0 15px var(--main-color); font-size: 1.8rem; margin: 10px 0; letter-spacing: 2px; text-align: center; }
        #chat-box { width: 95%; max-width: 700px; height: 450px; overflow-y: auto; background: var(--panel-bg); border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid #333; display: flex; flex-direction: column; }
        .message { max-width: 85%; padding: 10px 15px; margin: 8px 0; border-radius: 15px; position: relative; word-wrap: break-word; line-height: 1.4; }
        .my-message { background-color: var(--main-color); color: #000; align-self: flex-end; border-bottom-right-radius: 0; }
        .other-message { background-color: #333; color: #fff; align-self: flex-start; border-bottom-left-radius: 0; }
        #top-buttons-container { position: fixed; top: 15px; right: 15px; display: flex; gap: 15px; z-index: 1000; }
        .top-button { background-color: var(--main-color); color: black; font-size: 20px; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; border: none; position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold; border: 1px solid white; }
        #onlineList, #friendsListContainer { position: fixed; right: 70px; top: 15px; width: 260px; background: #222; padding: 15px; border-radius: 10px; display: none; max-height: 80vh; overflow-y: auto; border: 1px solid var(--main-color); z-index: 1001; }
        .close-panel-btn { width: 100%; margin-top: 10px; background: #444; color: #fff; border: none; padding: 8px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .input-group { width: 95%; max-width: 700px; display: flex; gap: 10px; margin-top: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; outline: none; }
        button { background: var(--main-color); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #333; }
        .add-friend-btn { background: var(--main-color); color: #000; border: none; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>
    <div id="top-buttons-container">
        <button class="top-button" onclick="showOnlineList()">ğŸ‘¥ <span id="onlineCount" class="badge">0</span></button>
        <button class="top-button" onclick="toggleElement('friendsListContainer')">ğŸ¤ <span id="friendsCount" class="badge">0</span></button>
    </div>
    <div id="onlineList"><strong>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†:</strong><div id="usersListContent"></div><button class="close-panel-btn" onclick="toggleElement('onlineList')">Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div id="friendsListContainer"><strong>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡:</strong><div id="friendsListContent"></div><button class="close-panel-btn" onclick="toggleElement('friendsListContainer')">Ø¥ØºÙ„Ø§Ù‚</button></div>
    <div class="brand-title">â„¤ğ”¼ğ•ğ”¼ğ•€ğ•ƒ â„‚â„ğ”¸ğ•‹ ğ•ƒğ•€ğ•‹ğ”¼</div>
    <div id="login-section" style="width: 95%; max-width: 400px; text-align: center; background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #333;">
        <input type="text" id="roomCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©"><input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±"><button onclick="joinRoom()" style="width: 100%; margin-top: 10px;">Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div id="pointsDisplay" style="margin: 10px 0; color: var(--main-color); font-weight: bold;">ğŸ¯ Ø±ØµÙŠØ¯Ùƒ: 0</div>
    <div id="chat-box"><div id="messages-container"></div></div>
    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
        databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "zeweil-chat",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentRoom = "", currentUser = "", userId = "";

    firebase.auth().onAuthStateChanged(user => {
        if (user) { userId = user.uid; db.ref(`users/${userId}/points`).on('value', s => { document.getElementById('pointsDisplay').innerText = `ğŸ¯ Ø±ØµÙŠØ¯Ùƒ: ${s.val() || 0}`; }); }
        else { firebase.auth().signInAnonymously(); }
    });

    function joinRoom() {
        const room = document.getElementById('roomCode').value.trim();
        const name = document.getElementById('username').value.trim();
        if (!room || !name) return alert("Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ§ Ø¨Ø·Ù„");
        currentRoom = room; currentUser = name;
        document.getElementById('login-section').style.display = 'none';

        const myPresenceRef = db.ref(`rooms/${room}/users/${userId}`);
        const connectedRef = db.ref(".info/connected");

        connectedRef.on("value", snap => {
            if (snap.val() === true) {
                // Ù„Ù…Ø§ ÙŠØ®Ø±Ø¬ØŒ ÙŠÙ…Ø³Ø­ Ù†ÙØ³Ù‡ ÙÙˆØ±Ø§Ù‹
                myPresenceRef.onDisconnect().remove();
                // ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡
                myPresenceRef.set({ name: name, lastActive: firebase.database.ServerValue.TIMESTAMP });
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ±
        db.ref(`rooms/${room}/users`).on('value', s => {
            const users = s.val() || {};
            const count = Object.keys(users).length;
            document.getElementById('onlineCount').innerText = count;
            updateOnlineUI(users);
        });

        db.ref(`rooms/${room}/messages`).limitToLast(15).on('child_added', s => addMessage(s.key, s.val()));
    }

    function updateOnlineUI(users) {
        const content = document.getElementById('usersListContent');
        content.innerHTML = "";
        for (let id in users) {
            const row = document.createElement('div');
            row.className = 'user-row';
            let addBtn = (id !== userId) ? `<button class="add-friend-btn" onclick="sendFriendRequest('${id}', '${users[id].name}')">â• Ø¥Ø¶Ø§ÙØ©</button>` : "";
            row.innerHTML = `<span>ğŸŸ¢ ${users[id].name}</span> ${addBtn}`;
            content.appendChild(row);
        }
    }

    function addMessage(key, data) {
        if (document.getElementById(key)) return;
        const container = document.getElementById('messages-container');
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.id = key;
        const isMine = data.userId === userId;
        div.className = `message ${isMine ? 'my-message' : 'other-message'}`;
        div.innerHTML = `<strong>${data.name}:</strong><br>${data.message}`;
        container.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (!input.value.trim()) return;
        db.ref(`rooms/${currentRoom}/messages`).push({ userId, name: currentUser, message: input.value.trim(), timestamp: Date.now() });
        input.value = "";
    }

    function sendFriendRequest(targetId, targetName) {
        db.ref(`users/${targetId}/friendRequests/${userId}`).set({ fromName: currentUser, timestamp: Date.now() })
        .then(() => alert(`ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${targetName}`));
    }

    function showOnlineList() { toggleElement('onlineList'); }
    function toggleElement(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
</script>
</body>
</html>
