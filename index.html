<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z_Chat | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <style>
        :root { --main-color: #0f0; --bg-dark: #111; --panel-bg: #1a1a1a; }
        body { background-color: var(--bg-dark); color: white; font-family: Tahoma, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        h2 { color: var(--main-color); text-shadow: 0 0 10px var(--main-color); }
        
        /* Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© */
        #chat-box { width: 95%; max-width: 700px; height: 450px; overflow-y: auto; background: var(--panel-bg); border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid #333; display: flex; flex-direction: column; }
        .message { max-width: 85%; padding: 10px 15px; margin: 8px 0; border-radius: 15px; position: relative; word-wrap: break-word; line-height: 1.4; }
        .my-message { background-color: var(--main-color); color: #000; align-self: flex-end; border-bottom-right-radius: 0; }
        .other-message { background-color: #333; color: #fff; align-self: flex-start; border-bottom-left-radius: 0; }
        
        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        #top-buttons-container { position: fixed; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 1000; }
        .top-button { background-color: var(--main-color); color: black; font-size: 20px; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; border: none; }
        
        #onlineList, #friendsListContainer { position: fixed; right: 70px; top: 15px; width: 250px; background: #222; padding: 15px; border-radius: 10px; display: none; max-height: 80vh; overflow-y: auto; border: 1px solid var(--main-color); z-index: 1001; }
        
        /* Ù…Ø¸Ù‡Ø± Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ */
        .youtube-preview { display: block; margin-top: 8px; border-radius: 8px; overflow: hidden; border: 1px solid #444; text-decoration: none; }
        .youtube-preview img { width: 100%; display: block; }
        .youtube-preview-title { padding: 5px; font-size: 12px; background: #000; color: #fff; text-align: center; }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .input-group { width: 95%; max-width: 700px; display: flex; gap: 10px; margin-top: 10px; }
        input[type="text"], input[type="password"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; }
        button { background: var(--main-color); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* Ø§Ù„Ø±Ø¯ÙˆØ¯ ÙˆØ§Ù„Ù‡Ø¯Ø§ÙŠØ§ */
        #reply-box { width: 95%; max-width: 700px; background: #222; border-right: 4px solid var(--main-color); padding: 10px; margin-bottom: 5px; display: none; border-radius: 5px; }
        .rank-icon { width: 24px; height: 24px; vertical-align: middle; margin: 0 5px; }
        .system-message { color: #888; font-style: italic; text-align: center; font-size: 0.9em; }
    </style>
</head>
<body>

    <div id="top-buttons-container">
        <button class="top-button" onclick="toggleElement('onlineList')" title="Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†">ğŸ‘¥</button>
        <button class="top-button" onclick="toggleElement('friendsListContainer')" title="Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡">ğŸ¤</button>
        <a id="rankShopLink" class="top-button" title="Ø§Ù„Ù…ØªØ¬Ø±">ğŸ›’</a>
    </div>

    <div id="onlineList"><strong>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†:</strong><div id="usersListContent"></div></div>
    
    <div id="friendsListContainer">
        <h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©</h4>
        <div id="friendRequestsList"></div>
        <hr>
        <h4>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h4>
        <div id="friendsList"></div>
    </div>

    <h2>ğŸŒ â„¤ ğ”¼ ğ• ğ”¼ ğ•€ ğ•ƒ  â„‚ â„ ğ”¸ ğ•‹</h2>

    <div id="login-section">
        <input type="text" id="roomCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
        <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ">
        <button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="pointsDisplay" style="margin: 10px 0; color: var(--main-color);">Ø±ØµÙŠØ¯Ùƒ: 0 ğŸ¯</div>

    <div id="chat-box">
        <button id="loadOlderBtn" style="display:none; margin: auto;" onclick="loadOlderMessages()">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ù‚Ø¯Ù…</button>
    </div>

    <div id="reply-box">
        <div id="replySender" style="color: var(--main-color); font-weight: bold;"></div>
        <div id="replyText" style="font-size: 0.8em; opacity: 0.7;"></div>
        <button onclick="closeReplyBox()" style="padding: 2px 5px; margin-top: 5px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <div style="margin-top: 15px; display: flex; gap: 10px;">
        <button onclick="startCall('video')">ğŸ“¹ ÙÙŠØ¯ÙŠÙˆ</button>
        <button onclick="startCall('voice')">ğŸ“ ØµÙˆØª</button>
    </div>

    <div id="passwordModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#222; padding:20px; border:2px solid var(--main-color); z-index:2000;">
        <p>Ø§Ù„ØºØ±ÙØ© Ù…Ø­Ù…ÙŠØ©ØŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</p>
        <input type="password" id="roomPasswordInput">
        <button onclick="verifyRoomPassword()">Ø¯Ø®ÙˆÙ„</button>
    </div>

<script>
    // ØªÙƒÙˆÙŠÙ† Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    const firebaseConfig = {
        apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
        authDomain: "zeweil-chat.firebaseapp.com",
        databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "zeweil-chat",
        storageBucket: "zeweil-chat.appspot.com",
        messagingSenderId: "79843372176",
        appId: "1:79843372176:web:ea511efffae60c2a6cfc15",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentRoom = "", currentUser = "", userId = "", replyingTo = null;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            userId = user.uid;
            setupUserAccount();
        } else {
            firebase.auth().signInAnonymously();
        }
    });

    function setupUserAccount() {
        db.ref(`users/${userId}/points`).on('value', s => {
            document.getElementById('pointsDisplay').innerText = `Ø±ØµÙŠØ¯Ùƒ: ${s.val() || 0} ğŸ¯`;
        });
        document.getElementById('rankShopLink').href = `https://zeweil-chat.vercel.app/rank-shop.html?uid=${userId}`;
        checkDailyReward();
        listenToFriends();
    }

    function joinRoom() {
        const room = document.getElementById('roomCode').value.trim();
        const name = document.getElementById('username').value.trim();
        if (!room || !name) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        db.ref(`rooms/${room}`).once('value', s => {
            const data = s.val();
            if (data && data.status === 'passwordProtected') {
                window.pendingRoom = { room, name, pass: data.password };
                document.getElementById('passwordModal').style.display = 'block';
            } else {
                proceedJoin(room, name);
            }
        });
    }

    function verifyRoomPassword() {
        const input = document.getElementById('roomPasswordInput').value;
        if (input === window.pendingRoom.pass) {
            document.getElementById('passwordModal').style.display = 'none';
            proceedJoin(window.pendingRoom.room, window.pendingRoom.name);
        } else {
            alert("Ø®Ø·Ø£");
        }
    }

    function proceedJoin(room, name) {
        currentRoom = room;
        currentUser = name;
        db.ref(`rooms/${room}/users/${userId}`).set({ name, online: true });
        db.ref(`users/${userId}`).update({ currentRoom: room, online: true, name: name });
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        const msgRef = db.ref(`rooms/${room}/messages`);
        msgRef.limitToLast(20).on('child_added', s => addMessage(s.key, s.val()));
        
        // Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø®ÙˆÙ„
        msgRef.push({ system: true, message: `ğŸ“¢ Ø¯Ø®Ù„ ${name} Ø§Ù„ØºØ±ÙØ©`, timestamp: Date.now() });
    }

    function addMessage(key, data) {
        if (document.getElementById(key)) return;
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.id = key;
        
        if (data.system) {
            div.className = 'system-message';
            div.innerText = data.message;
        } else {
            const isMine = data.userId === userId;
            div.className = `message ${isMine ? 'my-message' : 'other-message'}`;
            
            let content = `<strong>${data.name}:</strong><br>${parseMessage(data.message)}`;
            if (data.replyToData) {
                content = `<div style="font-size:0.7em; border-bottom:1px solid #666; margin-bottom:5px;">Ø±Ø¯ Ø¹Ù„Ù‰ ${data.replyToData.name}: ${data.replyToData.msg}</div>` + content;
            }
            
            div.innerHTML = content;
            div.onclick = () => prepareReply(key, data.name, data.message);
        }
        
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function parseMessage(text) {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„ÙŠÙˆØªÙŠÙˆØ¨
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, url => {
            const ytId = getYoutubeId(url);
            if (ytId) {
                return `<a href="${url}" target="_blank" class="youtube-preview">
                            <img src="https://img.youtube.com/vi/${ytId}/hqdefault.jpg">
                            <div class="youtube-preview-title">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¹Ù„Ù‰ YouTube</div>
                        </a>`;
            }
            return `<a href="${url}" target="_blank" style="color:inherit;">${url}</a>`;
        });
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const msg = input.value.trim();
        if (!msg || !currentRoom) return;

        const msgData = {
            userId: userId,
            name: currentUser,
            message: msg,
            timestamp: Date.now()
        };

        if (replyingTo) {
            msgData.replyToData = replyingTo;
            closeReplyBox();
        }

        db.ref(`rooms/${currentRoom}/messages`).push(msgData);
        input.value = "";
    }

    function prepareReply(key, name, msg) {
        replyingTo = { key, name, msg: msg.substring(0, 30) + "..." };
        document.getElementById('replySender').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${name}`;
        document.getElementById('replyText').innerText = msg;
        document.getElementById('reply-box').style.display = 'block';
    }

    function closeReplyBox() {
        replyingTo = null;
        document.getElementById('reply-box').style.display = 'none';
    }

    function toggleElement(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    function startCall(type) {
        if (!currentRoom) return alert("Ø§Ø¯Ø®Ù„ ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹");
        const url = `https://meet.jit.si/${currentRoom}${type === 'voice' ? '#config.startWithVideoMuted=true' : ''}`;
        window.open(url, '_blank');
    }

    function checkDailyReward() {
        const ref = db.ref(`users/${userId}/lastDaily`);
        ref.once('value', s => {
            const last = s.val() || 0;
            const now = Date.now();
            if (now - last > 86400000) { // 24 Ø³Ø§Ø¹Ø©
                db.ref(`users/${userId}/points`).transaction(p => (p || 0) + 25);
                ref.set(now);
                alert("ğŸ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ 25 Ù†Ù‚Ø·Ø© Ù…ÙƒØ§ÙØ£Ø© ÙŠÙˆÙ…ÙŠØ©!");
            }
        });
    }

    // Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
    function listenToFriends() {
        db.ref(`users/${userId}/friends`).on('value', s => {
            const list = document.getElementById('friendsList');
            list.innerHTML = "";
            s.forEach(child => {
                db.ref(`users/${child.key}`).once('value', fs => {
                    const fd = fs.val();
                    list.innerHTML += `<div style="padding:5px;">â€¢ ${fd.name} <span style="color:${fd.online?'#0f0':'#888'}">â—</span></div>`;
                });
            });
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    window.onbeforeunload = () => {
        if (userId) {
            db.ref(`users/${userId}/online`).set(false);
            if (currentRoom) db.ref(`rooms/${currentRoom}/users/${userId}`).remove();
        }
    };
</script>
</body>
</html>
