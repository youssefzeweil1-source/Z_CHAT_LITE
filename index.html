<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z_Chat | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <style>
        :root { --main-color: #0f0; --bg-dark: #111; --panel-bg: #1a1a1a; }
        body { background-color: var(--bg-dark); color: white; font-family: Tahoma, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        h2 { color: var(--main-color); text-shadow: 0 0 10px var(--main-color); }
        
        #chat-box { width: 95%; max-width: 700px; height: 450px; overflow-y: auto; background: var(--panel-bg); border-radius: 12px; padding: 15px; margin: 15px 0; border: 1px solid #333; display: flex; flex-direction: column; }
        .message { max-width: 85%; padding: 10px 15px; margin: 8px 0; border-radius: 15px; position: relative; word-wrap: break-word; line-height: 1.4; }
        .my-message { background-color: var(--main-color); color: #000; align-self: flex-end; border-bottom-right-radius: 0; }
        .other-message { background-color: #333; color: #fff; align-self: flex-start; border-bottom-left-radius: 0; }
        
        #top-buttons-container { position: fixed; top: 15px; right: 15px; display: flex; gap: 10px; z-index: 1000; }
        .top-button { background-color: var(--main-color); color: black; font-size: 20px; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; border: none; }
        
        /* ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ù„Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ */
        #onlineList { position: fixed; right: 70px; top: 15px; width: 250px; background: #222; padding: 15px; border-radius: 10px; display: none; max-height: 80vh; overflow-y: auto; border: 1px solid var(--main-color); z-index: 1001; }
        .close-panel-btn { width: 100%; margin-top: 10px; background: #444; color: #fff; border: none; padding: 8px; cursor: pointer; border-radius: 5px; }

        /* Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ù‚Ø¯Ù… */
        #loadOlderBtn { width: 100%; background: #1a1a1a; color: var(--main-color); border: 1px solid #333; padding: 8px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; display: none; }

        .youtube-preview { display: block; margin-top: 8px; border-radius: 8px; overflow: hidden; border: 1px solid #444; text-decoration: none; }
        .youtube-preview img { width: 100%; display: block; }
        .youtube-preview-title { padding: 5px; font-size: 12px; background: #000; color: #fff; text-align: center; }

        .input-group { width: 95%; max-width: 700px; display: flex; gap: 10px; margin-top: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; }
        button { background: var(--main-color); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        #reply-box { width: 95%; max-width: 700px; background: #222; border-right: 4px solid var(--main-color); padding: 10px; margin-bottom: 5px; display: none; border-radius: 5px; }
        .system-message { color: #888; font-style: italic; text-align: center; font-size: 0.9em; margin: 5px 0; }
    </style>
</head>
<body>

    <div id="top-buttons-container">
        <button class="top-button" onclick="showOnlineList()" title="Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†">ğŸ‘¥</button>
        <button class="top-button" onclick="toggleElement('friendsListContainer')" title="Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡">ğŸ¤</button>
        <a id="rankShopLink" class="top-button" title="Ø§Ù„Ù…ØªØ¬Ø±">ğŸ›’</a>
    </div>

    <div id="onlineList">
        <strong>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†:</strong>
        <div id="usersListContent"></div>
        <button class="close-panel-btn" onclick="toggleElement('onlineList')">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>
    
    <div id="friendsListContainer" style="display:none; position: fixed; right: 70px; top: 15px; width: 250px; background: #222; padding: 15px; border-radius: 10px; border: 1px solid var(--main-color); z-index: 1001;">
        <h4>Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</h4>
        <div id="friendsList"></div>
        <button class="close-panel-btn" onclick="toggleElement('friendsListContainer')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <h2>ğŸŒ â„¤ ğ”¼ ğ• ğ”¼ ğ•€ ğ•ƒ  â„‚ â„ ğ”¸ ğ•‹</h2>

    <div id="login-section">
        <input type="text" id="roomCode" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©">
        <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ">
        <button onclick="joinRoom()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="pointsDisplay" style="margin: 10px 0; color: var(--main-color);">Ø±ØµÙŠØ¯Ùƒ: 0 ğŸ¯</div>

    <div id="chat-box">
        <button id="loadOlderBtn" onclick="loadOlderMessages()">ğŸ“œ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ù‚Ø¯Ù…</button>
        <div id="messages-container"></div>
    </div>

    <div id="reply-box">
        <div id="replySender" style="color: var(--main-color); font-weight: bold;"></div>
        <div id="replyText" style="font-size: 0.8em; opacity: 0.7;"></div>
        <button onclick="closeReplyBox()" style="padding: 2px 5px; margin-top: 5px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div class="input-group">
        <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAlim9FOvDcMqTJWINoBCHk3k6DNXS-jTo",
        databaseURL: "https://zeweil-chat-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "zeweil-chat",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentRoom = "", currentUser = "", userId = "", replyingTo = null;
    let firstMessageKey = null; // Ù„ØªØªØ¨Ø¹ Ø£Ù‚Ø¯Ù… Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù…Ù„Ø©

    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            userId = user.uid;
            setupUserAccount();
        } else {
            firebase.auth().signInAnonymously();
        }
    });

    function setupUserAccount() {
        db.ref(`users/${userId}/points`).on('value', s => {
            document.getElementById('pointsDisplay').innerText = `Ø±ØµÙŠØ¯Ùƒ: ${s.val() || 0} ğŸ¯`;
        });
    }

    function joinRoom() {
        const room = document.getElementById('roomCode').value.trim();
        const name = document.getElementById('username').value.trim();
        if (!room || !name) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        currentRoom = room;
        currentUser = name;
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('loadOlderBtn').style.display = 'block';

        db.ref(`rooms/${room}/users/${userId}`).set({ name, online: true });
        
        // Ø¬Ù„Ø¨ Ø¢Ø®Ø± 10 Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
        const msgRef = db.ref(`rooms/${room}/messages`);
        msgRef.limitToLast(10).on('child_added', s => {
            if (!firstMessageKey) firstMessageKey = s.key;
            addMessage(s.key, s.val(), false);
        });

        msgRef.push({ system: true, message: `ğŸ“¢ Ø¯Ø®Ù„ ${name} Ø§Ù„ØºØ±ÙØ©`, timestamp: Date.now() });
    }

    function addMessage(key, data, isOld) {
        if (document.getElementById(key)) return;
        const container = document.getElementById('messages-container');
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.id = key;
        
        if (data.system) {
            div.className = 'system-message';
            div.innerText = data.message;
        } else {
            const isMine = data.userId === userId;
            div.className = `message ${isMine ? 'my-message' : 'other-message'}`;
            
            let content = `<strong>${data.name}:</strong><br>${parseMessage(data.message)}`;
            if (data.replyToData) {
                content = `<div style="font-size:0.7em; border-bottom:1px solid #666; margin-bottom:5px; opacity:0.8;">Ø±Ø¯ Ø¹Ù„Ù‰ ${data.replyToData.name}: ${data.replyToData.msg}</div>` + content;
            }
            div.innerHTML = content;
            div.onclick = () => prepareReply(key, data.name, data.message);
        }
        
        if (isOld) {
            container.prepend(div); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
        } else {
            container.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
    }

    // ÙˆØ¸ÙŠÙØ© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ù‚Ø¯Ù… (10 ÙÙŠ ÙƒÙ„ Ù…Ø±Ø©)
    function loadOlderMessages() {
        if (!firstMessageKey || !currentRoom) return;

        db.ref(`rooms/${currentRoom}/messages`)
            .orderByKey()
            .endAt(firstMessageKey)
            .limitToLast(11) // Ù†Ø¬Ù„Ø¨ 11 Ù„Ø£Ù† Ø§Ù„Ù€ 11 Ù‡ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© "Ø£ÙˆÙ„ ÙˆØ§Ø­Ø¯Ø©"
            .once('value', s => {
                let olderMsgs = [];
                s.forEach(child => {
                    if (child.key !== firstMessageKey) {
                        olderMsgs.push({ key: child.key, data: child.val() });
                    }
                });

                if (olderMsgs.length === 0) {
                    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø£Ù‚Ø¯Ù… Ù…Ù† Ø°Ù„Ùƒ");
                    document.getElementById('loadOlderBtn').style.innerText = "ÙˆØµÙ„Øª Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©";
                } else {
                    firstMessageKey = olderMsgs[0].key; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ø£ÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    olderMsgs.reverse().forEach(item => {
                        addMessage(item.key, item.data, true);
                    });
                }
            });
    }

    function parseMessage(text) {
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, url => {
            const ytId = getYoutubeId(url);
            if (ytId) {
                return `<a href="${url}" target="_blank" class="youtube-preview">
                            <img src="https://img.youtube.com/vi/${ytId}/hqdefault.jpg">
                            <div class="youtube-preview-title">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¹Ù„Ù‰ YouTube</div>
                        </a>`;
            }
            return `<a href="${url}" target="_blank" style="color:inherit;">${url}</a>`;
        });
    }

    function getYoutubeId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (!input.value.trim() || !currentRoom) return;

        const msgData = {
            userId: userId,
            name: currentUser,
            message: input.value.trim(),
            timestamp: Date.now()
        };

        if (replyingTo) {
            msgData.replyToData = replyingTo;
            closeReplyBox();
        }

        db.ref(`rooms/${currentRoom}/messages`).push(msgData);
        input.value = "";
    }

    function showOnlineList() {
        toggleElement('onlineList');
        const content = document.getElementById('usersListContent');
        content.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        db.ref(`rooms/${currentRoom}/users`).once('value', s => {
            content.innerHTML = "";
            s.forEach(child => {
                content.innerHTML += `<div style="padding:5px; border-bottom:1px solid #333;">ğŸŸ¢ ${child.val().name}</div>`;
            });
        });
    }

    function prepareReply(key, name, msg) {
        replyingTo = { key, name, msg: msg.substring(0, 30) + "..." };
        document.getElementById('replySender').innerText = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${name}`;
        document.getElementById('replyText').innerText = msg;
        document.getElementById('reply-box').style.display = 'block';
    }

    function closeReplyBox() {
        replyingTo = null;
        document.getElementById('reply-box').style.display = 'none';
    }

    function toggleElement(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }
</script>
</body>
</html>
